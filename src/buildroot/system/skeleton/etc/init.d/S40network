#!/bin/bash
#
# Start the network....
#
if [[ -n $has_usb_nic ]]; then
    echo "Please unplug your device and replug it into the usb port"
    echo -n "Please press enter key to connect [Enter]"
    read -p "$*"
    echo "Sleeping for 5 seconds to allow USB to sync back with system"
    sleep 5
fi
# Enable loopback interface
echo "auto lo" > /etc/network/interfaces
echo "iface lo inet loopback" >> /etc/network/interfaces
echo "" >> /etc/network/interfaces
/sbin/ip addr add 127.0.0.1 dev lo
/sbin/ip link set lo up
primary_ifaces=$(egrep -i "($mac)" /sys/class/net/*/address | awk -F'(/)' '{print $5}')
for primary_iface in $primary_ifaces; do
    # Check if each interface is up and if not wait up to 3 seconds
    echo "Starting $primary_iface interface"
    echo "auto $primary_iface" >> /etc/network/interfaces
    echo "iface $primary_iface inet dhcp" >> /etc/network/
    echo "" >> /etc/network/interfaces
    /sbin/ip link set $primary_iface up
    sleep 1
    for retry in $(seq 3); do
        linkstate=$(/bin/cat /sys/class/net/$primary_iface/carrier)
        if [[ x$linkstate == x1 ]]; then
            /sbin/udhcpc -i $primary_iface --now
            [[ $? -eq 0 ]] && exit 0;
            echo "Trying again on interface $primary_iface..."
        fi
        sleep 1
    done
done
ifaces=$(egrep -v -i "($mac|00:00:00:00:00:00)" /sys/class/net/*/address | awk -F'(/)' '{print $5}')
for iface in $ifaces; do
    # Check if each interface is up and if not wait up to 10 seconds
    echo "Starting $iface interface"
    echo "auto $iface" >> /etc/network/interfaces
    echo "iface $iface inet dhcp" >> /etc/network/
    echo "" >> /etc/network/interfaces
    /sbin/ip link set $iface up
    sleep 1
    for retry in $(seq 3); do
        linkstate=$(/bin/cat /sys/class/net/$iface/carrier)
        if [[ x$linkstate == x1 ]]; then
            /sbin/udhcpc -i $iface --now
            [[ $? -eq 0 ]] && exit 0
            echo "trying again on interface $iface..."
        fi
        sleep 1
    done
done
[[ -z $primary_ifaces && -z $ifaces ]] && echo "No network interfaces found, kernel is probably missing a driver" || "Failed to get an IP!, Tried on interfaces(s): $primary_ifaces $ifaces"
echo "Please check your network setup and try again!"
[[ -z $isdebug ]] && sleep 60
[[ -z $isdebug ]] && reboot
echo "Press enter to continue"
read
exit 1
